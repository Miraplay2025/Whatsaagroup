<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Restore WhatsApp</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#fff;
  font-family:Arial;
  padding:20px
}
.card{
  background:#fff;
  color:#000;
  padding:20px;
  border-radius:14px;
  max-width:420px;
  margin:auto
}
input,button{
  width:100%;
  padding:14px;
  margin-top:10px;
  border-radius:10px;
  border:none;
  font-size:15px
}
button{
  background:#1e90ff;
  color:#fff;
  cursor:pointer
}
.log{
  background:#000;
  color:#0f0;
  height:180px;
  overflow:auto;
  margin-top:12px;
  padding:10px;
  font-size:13px;
  border-radius:8px
}
.group{
  background:#f1f1f1;
  margin-top:6px;
  padding:10px;
  border-radius:8px
}
.success{color:#00ff7f}
.error{color:#ff4d4d}
.warn{color:#ffd700}
small{color:#666}
</style>
</head>

<body>

<div class="card">
  <h2>üîÑ Restaurar Sess√£o WhatsApp</h2>

  <input type="file" id="zip">
  <button onclick="upload()">üì§ Upload ZIP</button>

  <hr>

  <input id="url" placeholder="Cole link do Google Drive ou URL direta">
  <button onclick="restoreUrl()">üåê Restaurar por Link</button>

  <small>Links do Google Drive s√£o convertidos automaticamente</small>

  <div class="log" id="log"></div>
  <div id="result"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const logBox = document.getElementById('log');

function log(msg, type=''){
  logBox.innerHTML += `<div class="${type}">${msg}</div>`;
  logBox.scrollTop = logBox.scrollHeight;
}

/* ===========================
   CONVERTER LINK DRIVE
=========================== */
function convertDriveLink(url){
  try{
    if(url.includes('drive.google.com')){
      let id = null;

      // formato /file/d/ID/
      const match1 = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
      if(match1) id = match1[1];

      // formato ?id=ID
      const match2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
      if(match2) id = match2[1];

      if(id){
        const direct = `https://drive.google.com/uc?id=${id}&export=download`;
        log('üîÅ Link do Google Drive convertido automaticamente','warn');
        return direct;
      }
    }
  }catch(e){}
  return url;
}

/* ===========================
   UPLOAD
=========================== */
async function upload(){
  const f = document.getElementById('zip').files[0];
  if(!f) return alert('Selecione um arquivo ZIP');

  const fd = new FormData();
  fd.append('zip', f);

  log('üì§ Enviando ZIP...');
  await fetch('/upload',{ method:'POST', body:fd });
}

/* ===========================
   RESTORE URL
=========================== */
async function restoreUrl(){
  let url = document.getElementById('url').value.trim();
  if(!url) return alert('Cole o link');

  url = convertDriveLink(url);
  log('üåê Enviando link para o servidor...');

  await fetch('/restore-url',{
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ url })
  });
}

/* ===========================
   SOCKET EVENTS
=========================== */
socket.on('log', d=>{
  log(d.msg, d.type);
});

socket.on('session-data', d=>{
  document.getElementById('result').innerHTML = `
    <h3>‚úÖ ${d.name} (${d.number})</h3>
    <h4>Grupos (${d.groups.length})</h4>
    ${d.groups.map(g=>`
      <div class="group">
        <strong>${g.name}</strong><br>
        üë• ${g.members} membros
      </div>
    `).join('')}
  `;
});
</script>

</body>
</html>

